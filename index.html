<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LoanAmie Calculator</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--tg-theme-bg-color, #f4f4f5); 
            color: var(--tg-theme-text-color, #000000); 
            margin: 0; padding: 15px; box-sizing: border-box; 
            padding-bottom: 50px;
        }
        
        .tab-container { display: flex; background-color: #e4e4e5; border-radius: 8px; padding: 3px; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 8px 2px; font-size: 13px; font-weight: 500; border-radius: 6px; cursor: pointer; color: #8e8e93; }
        .tab.active { background-color: #ffffff; color: #000000; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .form-section { display: none; background-color: #ffffff; padding: 15px; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .form-section.active { display: block; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; margin-bottom: 5px; color: #8e8e93; }
        input, select { width: 100%; padding: 12px; border: 1px solid #e4e4e5; border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; color: #000; }
        
        #calc-btn { width: 100%; padding: 15px; margin-top: 20px; background-color: #2481cc; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        
        /* Result Box Styling */
        #result-container { 
            display: none; 
            margin-top: 20px; 
            padding: 15px; 
            background-color: #e8f4fd; 
            border-left: 5px solid #2481cc; 
            border-radius: 8px; 
            white-space: pre-wrap; 
            font-size: 14px;
            line-height: 1.5;
            color: #1a1a1a;
        }
        
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

    <div class="tab-container">
        <div class="tab active" onclick="switchTab(this, 'standard_emi')">Standard EMI</div>
        <div class="tab" onclick="switchTab(this, 'part_payment')">Fast Track</div>
        <div class="tab" onclick="switchTab(this, 'target_emi')">Affordability</div>
    </div>

    <div id="form_standard_emi" class="form-section active">
        <div class="input-group"><label>Loan Amount (₹)</label><input type="number" id="std_amount" placeholder="500000"></div>
        <div class="input-group"><label>Interest Rate (% p.a.)</label><input type="number" step="0.1" id="std_rate" placeholder="8.5"></div>
        <div class="input-group"><label>Tenure (Months)</label><input type="number" id="std_tenure" placeholder="120"></div>
    </div>

    <div id="form_part_payment" class="form-section">
        <div class="input-group"><label>Loan Amount (₹)</label><input type="number" id="pp_amount" placeholder="500000"></div>
        <div class="input-group"><label>Interest Rate (% p.a.)</label><input type="number" step="0.1" id="pp_rate" placeholder="8.5"></div>
        <div class="input-group"><label>Tenure (Months)</label><input type="number" id="pp_tenure" placeholder="120"></div>
        <div class="input-group"><label>Extra Payment (₹)</label><input type="number" id="pp_extra" placeholder="10000"></div>
        <div class="input-group">
            <label>Frequency</label>
            <select id="pp_freq"><option value="monthly">Monthly</option><option value="yearly">Yearly</option></select>
        </div>
    </div>

    <div id="form_target_emi" class="form-section">
        <div class="input-group"><label>Max Monthly EMI (₹)</label><input type="number" id="tgt_emi" placeholder="15000"></div>
    </div>

    <button id="calc-btn" onclick="calculateResult()">Calculate Now</button>

    <div id="result-container"></div>

    <script>
        // CHANGE THIS to your actual Cloud Function URL
        const GCP_URL = "https://us-central1-loanamie.cloudfunctions.net/loanamie-webhook";
        
        let currentAction = 'standard_emi';
        let tg = window.Telegram ? window.Telegram.WebApp : null;

        if (tg) {
            tg.expand();
            // We use a custom button inside HTML for better reliability 
            // than the TG MainButton for direct API calls
        }

        function switchTab(tabElement, actionName) {
            currentAction = actionName;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tabElement.classList.add('active');
            document.querySelectorAll('.form-section').forEach(f => f.classList.remove('active'));
            document.getElementById('form_' + actionName).classList.add('active');
            document.getElementById('result-container').style.display = 'none';
        }

        async function calculateResult() {
            const btn = document.getElementById('calc-btn');
            const resultBox = document.getElementById('result-container');
            
            let payload = { action: currentAction };

            if (currentAction === 'standard_emi') {
                payload.amount = document.getElementById('std_amount').value;
                payload.rate = document.getElementById('std_rate').value;
                payload.tenure = document.getElementById('std_tenure').value;
            } else if (currentAction === 'part_payment') {
                payload.amount = document.getElementById('pp_amount').value;
                payload.rate = document.getElementById('pp_rate').value;
                payload.tenure = document.getElementById('pp_tenure').value;
                payload.part_payment = document.getElementById('pp_extra').value;
                payload.frequency = document.getElementById('pp_freq').value;
            } else if (currentAction === 'target_emi') {
                payload.target_emi = document.getElementById('tgt_emi').value;
            }

            if (Object.values(payload).some(v => v === "" || v === undefined)) {
                alert("Please fill all fields");
                return;
            }

            // Show loading state
            btn.innerText = "Calculating...";
            btn.classList.add('loading');
            resultBox.style.display = 'none';

            try {
                const response = await fetch(GCP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    // Note: Since we want to display the message in the app, 
                    // we expect the JSON back. 
                    const data = await response.json();
                    
                    // Clean up Markdown-style bolding for HTML display
                    let cleanMessage = data.message || "No response message.";
                    cleanMessage = cleanMessage.replace(/\*\*/g, "").replace(/\*/g, "");
                    
                    resultBox.innerText = cleanMessage;
                    resultBox.style.display = 'block';
                    
                    // Haptic feedback for Telegram users
                    if (tg && tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                } else {
                    alert("Error: Server returned " + response.status);
                }
            } catch (error) {
                console.error(error);
                alert("Connection failed. Is the Backend running?");
            } finally {
                btn.innerText = "Calculate Now";
                btn.classList.remove('loading');
            }
        }
    </script>
</body>
</html>
